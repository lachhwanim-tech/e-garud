<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-GARUD Analysis Report</title>
    <link href="report.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* Modern E-GARUD Theme (Live Match) */
        :root {
            --font-main: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            --bg-color: #020024;
            --text-color: #ffffff;
            --accent-color: #00d4ff;
            --border-color: rgba(255, 255, 255, 0.1);
        }
        body { font-family: var(--font-main); background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px; }
        .report-container { max-width: 1200px; margin: 0 auto; background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); padding: 30px; border-radius: 15px; border: 1px solid var(--border-color); }
        .logo { display: block; margin: 0 auto 15px auto; width: 250px; }
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); justify-content: center; align-items: center; z-index: 1000; }
        .download-button, .back-button { display: none; width: 48%; padding: 15px; font-weight: bold; border-radius: 8px; cursor: pointer; border:none; margin-top:20px; }
        .download-button { background: linear-gradient(45deg, #00d4ff, #0077cc); color: white; }
        .back-button { background: #444; color: white; float: right; }
        .tab-pane { display: none; padding-top: 20px; }
        .tab-pane.active { display: block; }
        .report-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; background: rgba(0,0,0,0.3); }
        .report-table th, .report-table td { border: 1px solid rgba(255,255,255,0.1); padding: 10px; text-align: left; font-size: 0.9rem; }
        .report-table th { background-color: #090979; color: var(--accent-color); }
        
        /* CLI Inputs */
        textarea, input[type="text"] { background: rgba(255,255,255,0.1); border: 1px solid #555; color: white; padding: 8px; border-radius: 4px; }
        .abnormality-group { margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay"><div style="color:white; font-size:1.5em;">Processing...</div></div>
    <div class="report-container">
        <img src="railway logo.png" alt="Railway Logo" class="logo">
        <h1 style="text-align:center; color:var(--accent-color);">E-GARUD (ई-गरुड़)</h1>
        <h3 style="text-align:center;">DRIVING MONITORING & ANALYSIS REPORT</h3>
        
        <div class="tabs" style="display:flex; gap:10px; margin-bottom:20px;">
            <button class="tab-button active" onclick="openTab('train-details')" style="flex:1; padding:10px; background:rgba(255,255,255,0.1); border:1px solid #444; color:white;">Train Details</button>
            <button class="tab-button" onclick="openTab('driving-analysis')" style="flex:1; padding:10px; background:rgba(255,255,255,0.1); border:1px solid #444; color:white;">Driving Analysis</button>
            <button class="tab-button" onclick="openTab('cli-observation')" style="flex:1; padding:10px; background:rgba(255,255,255,0.1); border:1px solid #444; color:white;">CLI Observation</button>
        </div>

        <div id="reportContent">
            <div id="train-details" class="tab-pane active"></div>

            <div id="driving-analysis" class="tab-pane">
                <h2>Driving Analysis (11-Point Pattern)</h2>
                <div id="driving-table-container"></div>
            </div>

            <div id="cli-observation" class="tab-pane">
                
                <div style="background:rgba(255,255,0,0.1); padding:15px; border-left:4px solid yellow; margin-bottom:20px;">
                    <h4>कृपया ध्यान दें!</h4>
                    <p>डाउनलोड बटन दबाने पर डेटा सेव हो जाएगा।</p>
                </div>

                <h3>Historical Abnormality Profile (Last 10)</h3>
                <div id="lp-history-list" style="background:rgba(0,0,0,0.2); padding:15px; border-radius:10px; margin-bottom:20px; min-height:50px;">
                    Loading history...
                </div>
                
                <h3>OVERALL OBSERVATION OF CLI</h3>
                <textarea id="cliRemarks" rows="5" style="width:100%;"></textarea>

                <h3>Detail of Abnormalities</h3>
                <div id="abnormalities-checkbox-container">
                    <div class="abnormality-group"><label><input type="checkbox" id="chk-bft-nd"> BFT not done</label></div>
                    <div class="abnormality-group"><label><input type="checkbox" id="chk-bpt-nd"> BPT not done</label></div>
                    <div class="abnormality-group"><label><input type="checkbox" id="chk-bft-rule" data-text-id="txt-bft-rule"> BFT not done as per rule</label>
                        <input type="text" id="txt-bft-rule" placeholder="Remark..." style="display:none; width:100%;"></div>
                    <div class="abnormality-group"><label><input type="checkbox" id="chk-bpt-rule" data-text-id="txt-bpt-rule"> BPT not done as per rule</label>
                        <input type="text" id="txt-bpt-rule" placeholder="Remark..." style="display:none; width:100%;"></div>
                    <div class="abnormality-group"><label><input type="checkbox" id="chk-late-ctrl" data-text-id="txt-late-ctrl"> Late Controlling</label>
                        <input type="text" id="txt-late-ctrl" placeholder="Location..." style="display:none; width:100%;"></div>
                    <div class="abnormality-group"><label><input type="checkbox" id="chk-overspeed" data-text-id="txt-overspeed"> Over speeding</label>
                        <input type="text" id="txt-overspeed" placeholder="Details..." style="display:none; width:100%;"></div>
                    <div class="abnormality-group"><label><input type="checkbox" id="chk-others" data-text-id="txt-others"> Other Abnormalities</label>
                        <input type="text" id="txt-others" placeholder="Details..." style="display:none; width:100%;"></div>
                </div>

                <h3>Total Abnormalities: <input type="number" id="totalAbnormality" readonly style="background:none; border:none; color:var(--accent-color); font-weight:bold; font-size:1.5rem; width:50px;"></h3>
                
                <div id="action-taken-section" style="margin-top:20px; background:rgba(255,255,255,0.05); padding:15px;">
                    <label style="display:block; margin-bottom:5px;"><input type="radio" name="actionTakenRadio" value="Intensive Counselled"> Intensive Counselled</label>
                    <label style="display:block; margin-bottom:5px;"><input type="radio" name="actionTakenRadio" value="Warning Letter Issued"> Warning Letter Issued</label>
                    <label style="display:block;"><input type="radio" name="actionTakenRadio" value="NIL"> NIL</label>
                </div>

                <div style="margin-top:20px;">
                    <button id="downloadReport" class="download-button">Download Report</button>
                    <button id="backToForm" class="back-button">Back to Form</button>
                </div>
            </div>
        </div>
    </div>

    <script src="googleApiHandler.js"></script>
    <script src="googlesheet.js"></script>

    <script>
    // --- DEAD REPORT LOGIC ---
    let reportData = {};
    const SCRIPT_URL_REPORT = 'https://script.google.com/macros/s/AKfycbyIpH28RYtLBazZQ1ehco5-rtenvNqnmn4FhnJdPz9Ww5KMbtm0-oZF2KMxWA9CLApg/exec';

    document.addEventListener('DOMContentLoaded', () => {
        try {
            reportData = JSON.parse(localStorage.getItem('spmReportData') || '{}');
            renderReport();
            
            // Tab Logic
            window.openTab = (tabId) => {
                document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                document.getElementById(tabId).classList.add('active');
                // Highlight button logic can be added here
                
                if(tabId === 'cli-observation') {
                    document.getElementById('downloadReport').style.display = 'inline-block';
                    document.getElementById('backToForm').style.display = 'inline-block';
                }
            };

            // Checkbox logic
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.onchange = (e) => {
                    const tid = e.target.getAttribute('data-text-id');
                    if(tid) document.getElementById(tid).style.display = e.target.checked ? 'block' : 'none';
                    document.getElementById('totalAbnormality').value = document.querySelectorAll('#abnormalities-checkbox-container input:checked').length;
                };
            });

            // Back Button
            document.getElementById('backToForm').onclick = () => {
                localStorage.removeItem('spmReportData');
                window.location.href = 'index.html';
            };

        } catch(e) { console.error(e); }
    });

    function renderReport() {
        if (!reportData.trainDetails) return;

        // Train Details
        document.getElementById('train-details').innerHTML = `<table class="report-table">
            ${reportData.trainDetails.map(d => `<tr><th>${d.label}</th><td>${d.value}</td></tr>`).join('')}
        </table>`;

        // Driving Analysis (11-Point)
        if(reportData.stops) {
            let html = `<table class="report-table">
            <tr><th>Sr</th><th>Loc</th><th>Time</th><th>Km</th><th>2000</th><th>1000</th><th>800</th><th>600</th><th>500</th><th>400</th><th>300</th><th>100</th><th>50</th><th>20</th><th>0</th><th>Analysis</th><th>Remark</th></tr>`;
            
            reportData.stops.forEach((s, i) => {
                const sp = s.speedsBefore || Array(11).fill(0);
                html += `<tr>
                    <td>${s.group}</td><td>${s.stopLocation}</td><td>${s.timeString.split(' ')[1]}</td><td>${(s.kilometer/1000).toFixed(2)}</td>
                    <td>${sp[0]||0}</td><td>${sp[1]||0}</td><td>${sp[2]||0}</td><td>${sp[3]||0}</td><td>${sp[4]||0}</td>
                    <td>${sp[5]||0}</td><td>${sp[6]||0}</td><td>${sp[7]||0}</td><td>${sp[8]||0}</td><td>${sp[9]||0}</td><td>${sp[10]||0}</td>
                    <td><select class="system-analysis-dropdown" data-stop-index="${i}"><option value="Smooth" ${s.brakingTechnique==='Smooth'?'selected':''}>Smooth</option><option value="Late" ${s.brakingTechnique==='Late'?'selected':''}>Late</option></select></td>
                    <td><input type="text" class="cli-remark-input-row" data-stop-index="${i}" style="width:100%"></td>
                </tr>`;
            });
            html += `</table>`;
            document.getElementById('driving-table-container').innerHTML = html;
        }

        // History Fetching (DEAD LOGIC)
        if (reportData.lpDetails) {
            const val = reportData.lpDetails.find(s => s.includes('ID'));
            const lpId = val ? val.split(':')[1].trim() : '';
            fetchHistoryDead(lpId);
        }
    }

    async function fetchHistoryDead(lpId) {
        const list = document.getElementById('lp-history-list');
        if(!lpId) { list.innerHTML = "No LP ID found."; return; }
        
        try {
            const res = await fetch(SCRIPT_URL_REPORT);
            const rawData = await res.json();
            // Code.gs returns array of arrays. Col D (Index 3) is LP ID. Col R (Index 17) is Abnormality.
            const recs = rawData.filter(r => String(r[3]).trim() === lpId && r[17] !== 'NIL');
            
            if(recs.length === 0) { list.innerHTML = "No previous abnormalities found."; return; }

            let html = `<ul style="padding-left:20px;">`;
            recs.slice(-10).reverse().forEach(r => {
                const date = new Date(r[0]).toLocaleDateString('en-GB');
                html += `<li style="margin-bottom:5px; border-bottom:1px solid #444;">
                    <span style="color:#ff4d4d">${r[17]}</span> <span style="color:#aaa; font-size:0.8em">(${date})</span>
                </li>`;
            });
            html += `</ul>`;
            list.innerHTML = html;
        } catch(e) {
            list.innerHTML = "Error loading history from database.";
        }
    }

    // PDF Generation (Landscape logic included)
    window.generatePDF = async function() { // Called by googlesheet.js
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'portrait' });
        
        // 1. Header & Summary (Portrait)
        doc.setFillColor(2, 0, 36); doc.rect(0, 0, 210, 25, 'F');
        doc.setFontSize(16); doc.setTextColor(255);
        doc.text("E-GARUD REPORT", 105, 15, { align: 'center' });
        
        doc.setTextColor(0); doc.setFontSize(10);
        let y = 35;
        
        // Simple tables for summary
        const trainRows = reportData.trainDetails.map(t => [t.label, t.value]);
        doc.autoTable({ head:[['Item', 'Value']], body:trainRows, startY:y });
        y = doc.lastAutoTable.finalY + 10;

        // 2. Add Landscape Page for 11-Point Table
        doc.addPage('a4', 'landscape');
        doc.text("Driving Analysis (11-Point Braking)", 14, 15);
        
        const drivingRows = reportData.stops.map((s, i) => {
            const sys = document.querySelector(`.system-analysis-dropdown[data-stop-index="${i}"]`).value;
            const rem = document.querySelector(`.cli-remark-input-row[data-stop-index="${i}"]`).value;
            const sp = s.speedsBefore || [];
            return [
                s.group, s.stopLocation, s.timeString.split(' ')[1], (s.kilometer/1000).toFixed(2),
                sp[0], sp[1], sp[2], sp[3], sp[4], sp[5], sp[6], sp[7], sp[8], sp[9], sp[10],
                sys, rem
            ];
        });

        doc.autoTable({
            head: [['Sr','Loc','Time','Km','2000','1000','800','600','500','400','300','100','50','20','0','Sys','Rem']],
            body: drivingRows,
            startY: 20,
            styles: { fontSize: 8 },
            headStyles: { fillColor: [9, 9, 121] }
        });

        // 3. Save
        doc.save(`E-GARUD_Report_${Date.now()}.pdf`);
    };
    </script>
</body>
</html>
