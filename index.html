<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-GARUD Analysis Form</title>
    <link href="styles.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="googleApiHandler.js"></script>
    
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        /* Modern E-GARUD Theme */
        :root {
            --bg-gradient: linear-gradient(160deg, #020024 0%, #090979 35%, #00d4ff 100%);
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            --text-color: #ffffff;
            --text-muted: #a0a0a0;
            --accent-color: #00d4ff;
            --danger-color: #ff4d4d;
            --font-main: 'Segoe UI', 'Roboto', Helvetica, Arial, sans-serif;
        }

        body {
            font-family: var(--font-main);
            background: var(--bg-gradient);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .container {
            width: 100%;
            max-width: 1250px;
            padding: 30px;
        }

        .logo {
            display: block;
            margin: 0 auto 20px auto;
            width: 280px;
            height: auto;
            filter: drop-shadow(0 0 10px rgba(0, 212, 255, 0.4));
        }

        .header-title h1 {
            font-size: 3.5rem;
            margin: 0;
            text-align: center;
            color: var(--accent-color);
            text-transform: uppercase;
            letter-spacing: 3px;
            text-shadow: 0 0 20px rgba(0, 212, 255, 0.6);
        }

        .header-sub {
            text-align: center;
            margin-top: 10px;
            margin-bottom: 30px;
        }

        .header-sub h3 {
            font-size: 1.2rem;
            margin: 5px 0;
            background: var(--glass-bg);
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            border: var(--glass-border);
        }

        .header-sub h4 {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin: 5px 0;
            font-weight: 400;
        }

        /* Glass Box */
        .box {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: var(--glass-border);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--glass-border);
            padding-bottom: 10px;
        }

        .section-header h2 {
            margin: 0;
            font-size: 1.3rem;
            color: var(--accent-color);
            text-transform: uppercase;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .form-section {
            flex: 1;
            min-width: 300px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 0.9rem;
        }

        input, select {
            width: 100%;
            padding: 12px 15px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #fff;
            font-size: 1rem;
            box-sizing: border-box;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
        }

        input[readonly] {
            background: rgba(255, 255, 255, 0.05);
            cursor: not-allowed;
            border-style: dashed;
        }

        button.manual-entry-btn {
            background: var(--danger-color);
            color: white;
            border: none;
            padding: 5px 12px;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
        }

        button[type="submit"] {
            width: 100%;
            padding: 16px;
            background: linear-gradient(90deg, var(--accent-color), #0077cc);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.2rem;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.4);
            margin-top: 10px;
        }

        button[type="submit"]:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 212, 255, 0.6);
        }

        /* History List */
        #lp-abnormalities-list, #lp-abnormality-summary-list {
            font-size: 0.9rem;
            line-height: 1.5;
        }
        #lp-abnormality-summary-list li {
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding: 4px 0;
            display: flex;
            justify-content: space-between;
        }

        /* Toast Notification */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast-message {
            background: #fff;
            color: #333;
            padding: 15px 25px;
            border-radius: 8px;
            border-left: 5px solid var(--accent-color);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.4s ease;
            font-weight: 600;
        }
        .toast-message.show { opacity: 1; transform: translateX(0); }

        /* Loading Overlay */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85);
            justify-content: center;
            align-items: center;
            z-index: 3000;
            flex-direction: column;
        }
        .loading-text { color: white; margin-top: 20px; font-size: 1.2rem; }
    </style>
</head>
<body>

    <div class="container">
        <img src="railway logo.png" alt="Railway Logo" class="logo">
        <div class="header-title">
            <h1>E-GARUD (ई-गरुड़)</h1>
        </div>
        <div class="header-sub">
            <h3>ON BOARD CREW DRIVING MONITORING SYSTEM</h3><br>
            <h4>TELOC CELL, Electrical(OP) RAIPUR DIVISION, S.E.C.R.<br>
            (TELOC प्रकोष्ठ, विद्युत (परिचालन) विभाग, रायपुर मंडल, दक्षिण पूर्व मध्य रेलवे)</h4>
        </div>

        <form id="spmForm">
            <div class="form-row">
                <div class="form-section">
                    <div class="section-header">
                        <h2>LP DETAILS</h2>
                        <button type="button" id="manualLpBtn" class="manual-entry-btn">Manual Entry</button>
                    </div>
                    <div class="box">
                        <div class="form-group"><label>LP ID</label><input type="text" id="lpId" required placeholder="Enter ID (e.g., R1234)"></div>
                        <div class="form-group"><label>LP Name</label><input type="text" id="lpName" readonly></div>
                        <div class="form-group"><label>Designation</label><input type="text" id="lpDesg" readonly></div>
                        <div class="form-group"><label>Group CLI</label><input type="text" id="lpGroupCli" readonly></div>
                        <div class="form-group"><label>CUG Number</label><input type="text" id="lpCugNumber" readonly></div>
                    </div>

                    <div class="section-header"><h2>History Profile</h2></div>
                    <div class="box"><div id="lp-abnormalities-list">Enter LP ID to view records.</div></div>
                    <div class="box">
                        <ul id="lp-abnormality-summary-list">
                            <li>BFT not done: <strong id="bft-not-done-count">0</strong></li>
                            <li>BPT not done: <strong id="bpt-not-done-count">0</strong></li>
                            <li>Rule Violation: <strong id="bft-rule-count">0</strong></li>
                            <li>Late Controlling: <strong id="late-controlling-count">0</strong></li>
                            <li>Overspeeding: <strong id="overspeeding-count">0</strong></li>
                            <li>Others: <strong id="others-abnormalities-count">0</strong></li>
                        </ul>
                    </div>
                </div>

                <div class="form-section">
                    <div class="section-header">
                        <h2>ALP DETAILS</h2>
                        <button type="button" id="manualAlpBtn" class="manual-entry-btn">Manual Entry</button>
                    </div>
                    <div class="box">
                        <div class="form-group"><label>ALP ID</label><input type="text" id="alpId" required></div>
                        <div class="form-group"><label>ALP Name</label><input type="text" id="alpName" readonly></div>
                        <div class="form-group"><label>Designation</label><input type="text" id="alpDesg" readonly></div>
                        <div class="form-group"><label>Group CLI</label><input type="text" id="alpGroupCli" readonly></div>
                        <div class="form-group"><label>CUG Number</label><input type="text" id="alpCugNumber" readonly></div>
                    </div>

                    <div class="section-header" style="margin-top: 30px;"><h2>TRAIN & SECTION</h2></div>
                    <div class="box">
                        <div class="form-group"><label>Loco Number</label><input type="text" id="locoNumber" required></div>
                        <div class="form-group"><label>Train Number</label><input type="text" id="trainNumber" required></div>
                        <div class="form-group">
                            <label>Type of Rake</label>
                            <select id="rakeType" required>
                                <option value="" disabled selected>Select</option>
                                <option value="GOODS">GOODS</option>
                                <option value="COACHING">COACHING</option>
                                <option value="MEMU">MEMU</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Section</label>
                            <select id="section" required><option value="" disabled selected>Select</option></select>
                        </div>
                        <div class="form-row">
                            <div class="form-group" style="flex:1"><label>From</label><select id="fromSection" required></select></div>
                            <div class="form-group" style="flex:1"><label>To</label><select id="toSection" required></select></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section-header"><h2>ANALYSIS PARAMETERS</h2></div>
            <div class="box">
                <div class="form-row">
                    <div class="form-group" style="flex:1">
                        <label>SPM Type</label>
                        <select id="spmType" required>
                            <option value="" disabled selected>Select Type</option>
                            <option value="Laxven">Laxven</option>
                            <option value="Medha">Medha</option>
                            <option value="Telpro">Telpro</option>
                            <option value="TelproNew">TelproNew</option>
                            <option value="MR">MR</option>
                            <option value="VEL">VEL</option>
                            <option value="RTIS">RTIS</option>
                            <option value="SHM">SHM (LocoSHM)</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex:1">
                        <label>Max Speed (kmph)</label>
                        <select id="maxPermissibleSpeed" required>
                            <option value="60">60</option>
                            <option value="75">75</option>
                            <option value="100">100</option>
                            <option value="110">110</option>
                            <option value="130">130</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group" style="flex:1"><label>CLI ID</label><input type="text" id="cliIdInput" required placeholder="Enter CLI ID"></div>
                    <div class="form-group" style="flex:1"><label>CLI Name</label><input type="text" id="cliName" readonly placeholder="Auto-filled"></div>
                    <div class="form-group" style="flex:1"><label>CLI HQ</label><input type="text" id="cliHqDisplay" readonly placeholder="Auto-filled"></div>
                </div>

                <div class="form-row">
                    <div class="form-group" style="flex:1"><label>From Date & Time</label><input type="datetime-local" id="fromDateTime" required></div>
                    <div class="form-group" style="flex:1"><label>To Date & Time</label><input type="datetime-local" id="toDateTime" required></div>
                </div>

                <div class="form-row">
                    <div class="form-group" style="flex:1"><label>Upload SPM File</label><input type="file" id="spmFile" required></div>
                    <div class="form-group" style="flex:1"><label>Upload CUG.csv (Optional)</label><input type="file" id="cugFile" accept=".csv"></div>
                </div>

                <button type="submit">ANALYZE SPM DATA</button>
            </div>
        </form>
    </div>

    <div id="toast-container"></div>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-text">Processing...</div>
    </div>
    <canvas id="speedChart" style="display:none"></canvas>
    <canvas id="stopChart" style="display:none"></canvas>

    <script>
    // --- UTILS ---
    window.toggleLoadingOverlay = (show) => document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
    
    function showToast(msg) {
        const div = document.createElement('div');
        div.className = 'toast-message';
        div.textContent = msg;
        document.getElementById('toast-container').appendChild(div);
        setTimeout(() => div.classList.add('show'), 10);
        setTimeout(() => div.remove(), 4000);
    }

    function loadScript(src, cb) {
        const old = document.querySelector(`script[src="${src}"]`);
        if(old) old.remove();
        const s = document.createElement('script');
        s.src = src;
        s.onload = cb;
        document.body.appendChild(s);
    }

    // --- MAIN LOGIC ---
    document.addEventListener('DOMContentLoaded', async () => {
        // Data Loading
        let crewData = [], stationSignalData = [], cliDataMap = {};
        
        const fetchCSV = async (url) => {
            try { return (await Papa.parse(await (await fetch(url)).text(), {header:true, skipEmptyLines:true})).data; } 
            catch { return []; }
        };

        // Load Static Data
        crewData = await fetchCSV('CREW.csv');
        stationSignalData = await fetchCSV('Station_Signal_Interdistant.csv');
        window.stationSignalData = stationSignalData; // Make global

        // Load CLI Data
        fetch('CLIMICRO.csv').then(r=>r.text()).then(t => {
            t.split('\n').slice(1).forEach(l => {
                const p = l.split(',');
                if(p[0]) cliDataMap[p[0].trim().toUpperCase()] = {name:p[1]?.trim(), hq:p[2]?.trim()};
            });
        });

        // Populate Dropdowns
        const secSelect = document.getElementById('section');
        [...new Set(stationSignalData.map(r=>r.SECTION))].forEach(s => secSelect.add(new Option(s,s)));
        
        secSelect.onchange = (e) => {
            const stns = [...new Set(stationSignalData.filter(r=>r.SECTION===e.target.value).map(r=>r.STATION))];
            const from = document.getElementById('fromSection'), to = document.getElementById('toSection');
            from.innerHTML = to.innerHTML = '<option selected disabled>Select</option>';
            stns.forEach(s => { from.add(new Option(s,s)); to.add(new Option(s,s)); });
        };

        // Auto-Fill Handlers
        const setupAutoFill = (idInput, nameId, desgId, cliId, cugId, isLp) => {
            document.getElementById(idInput).addEventListener('input', (e) => {
                const val = e.target.value.toUpperCase();
                e.target.value = val;
                const rec = crewData.find(c => c.CREWID === val);
                if(rec) {
                    document.getElementById(nameId).value = rec['CREW NAME'];
                    document.getElementById(desgId).value = rec.DESG;
                    document.getElementById(cliId).value = rec['CLI NAME'];
                    document.getElementById(cugId).value = rec['CUG NUMBER'];
                    if(isLp) fetchHistory(val);
                }
            });
        };
        setupAutoFill('lpId', 'lpName', 'lpDesg', 'lpGroupCli', 'lpCugNumber', true);
        setupAutoFill('alpId', 'alpName', 'alpDesg', 'alpGroupCli', 'alpCugNumber', false);

        document.getElementById('cliIdInput').addEventListener('input', (e) => {
            const val = e.target.value.toUpperCase();
            e.target.value = val;
            if(cliDataMap[val]) {
                document.getElementById('cliName').value = cliDataMap[val].name;
                document.getElementById('cliHqDisplay').value = cliDataMap[val].hq;
            }
        });

        // SPM Type Handler
        document.getElementById('spmType').onchange = (e) => {
            const type = e.target.value;
            const input = document.getElementById('spmFile');
            input.accept = (type==='Medha') ? '.txt' : (['MR','VEL'].includes(type) ? '.pdf' : '.xlsx,.xls,.csv');
            loadScript(`${type}.js`, () => console.log(`${type} Loaded`));
        };

        // Manual Entry
        document.getElementById('manualLpBtn').onclick = () => ['lpName','lpDesg','lpGroupCli','lpCugNumber'].forEach(i=>document.getElementById(i).readOnly=false);
        document.getElementById('manualAlpBtn').onclick = () => ['alpName','alpDesg','alpGroupCli','alpCugNumber'].forEach(i=>document.getElementById(i).readOnly=false);

        // --- SUBMIT HANDLER ---
        document.getElementById('spmForm').onsubmit = async (e) => {
            e.preventDefault();
            
            // Validation
            if(document.getElementById('fromSection').value === document.getElementById('toSection').value) 
                return alert("From and To stations cannot be same");
                
            localStorage.setItem('currentSessionHq', document.getElementById('cliHqDisplay').value);
            window.toggleLoadingOverlay(true);
            showToast("Starting E-GARUD Analysis...");

            try {
                // 1. Upload to Master Sheet
                const uploadRes = await uploadDataAndFileToGoogle();
                if(uploadRes.status !== 'success') throw new Error("Upload Failed");
                showToast("File Uploaded. Analyzing...");

                // 2. Parse CUG
                const cugFile = document.getElementById('cugFile').files[0];
                let cugData = [];
                if(cugFile) {
                    cugData = (await Papa.parse(await cugFile.text(), {header:true, skipEmptyLines:true})).data.map(r => ({
                        ...r, startDateTime: new Date(r['Start Date & Time']), endDateTime: new Date(r['End Date & Time']), duration: parseInt(r['Duration in Sec'])
                    }));
                }

                // 3. Call Specific Analysis Script
                const file = document.getElementById('spmFile').files[0];
                if(window.analyzeSPMData) await window.analyzeSPMData(file, cugData);
                else throw new Error("Analysis script not loaded. Select SPM Type again.");

            } catch(err) {
                console.error(err);
                alert("Error: " + err.message);
                window.toggleLoadingOverlay(false);
            }
        };

        // --- HISTORY FETCH (Primary Script) ---
        async function fetchHistory(id) {
            const list = document.getElementById('lp-abnormalities-list');
            list.innerHTML = "Fetching records...";
            try {
                // PRIMARY URL (Apps Script)
                const url = 'https://script.google.com/macros/s/AKfycbyIpH28RYtLBazZQ1ehco5-rtenvNqnmn4FhnJdPz9Ww5KMbtm0-oZF2KMxWA9CLApg/exec';
                const rows = await (await fetch(url)).json();
                
                const recs = rows.filter(r => String(r[3]).trim() === id); // Col D = LP ID
                if(!recs.length) return list.innerHTML = "No prior records.";
                
                list.innerHTML = recs.slice(-10).reverse().map(r => `<div><strong>${new Date(r[0]).toLocaleDateString()}:</strong> ${r[17]}</div>`).join('');
                
                // Counters
                let counts = {bft:0, bpt:0, rule:0, speed:0, other:0};
                recs.forEach(r => {
                    const txt = (r[17]||'').toLowerCase();
                    if(txt.includes('bft')) counts.bft++;
                    if(txt.includes('bpt')) counts.bpt++;
                    if(txt.includes('rule')) counts.rule++;
                    if(txt.includes('speed')) counts.speed++;
                });
                document.getElementById('bft-not-done-count').innerText = counts.bft;
                document.getElementById('overspeeding-count').innerText = counts.speed;
                // ... map others
            } catch(e) {
                list.innerHTML = "Error fetching history.";
            }
        }
    });
    </script>
</body>
</html>
