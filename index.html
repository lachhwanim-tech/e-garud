<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-GARUD | ‡§à ‡§ó‡§∞‡•Å‡§°‡§º</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="googleApiHandler.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        :root {
            --slate-bg: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.7);
            --accent: #38bdf8;
        }
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: var(--slate-bg); 
            color: #f8fafc; 
            overflow-x: hidden; 
        }
        .glass-card { 
            background: var(--card-bg); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            border-radius: 1.5rem; 
        }
        .input-modern { 
            background: rgba(15, 23, 42, 0.8); 
            border: 1px solid rgba(56, 189, 248, 0.2); 
            color: white; 
            border-radius: 0.75rem; 
            padding: 0.8rem; 
            width: 100%; 
            transition: all 0.2s; 
        }
        .input-modern:focus { 
            border-color: var(--accent); 
            outline: none; 
            box-shadow: 0 0 15px rgba(56, 189, 248, 0.2); 
        }
        .btn-analyze { 
            background: linear-gradient(135deg, #0ea5e9 0%, #6366f1 100%); 
            font-weight: 800; 
            cursor: pointer; 
            transition: all 0.3s ease; 
        }
        .btn-analyze:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4); 
        }
    </style>
</head>
<body class="p-4 lg:p-8 min-h-screen">
    <div class="max-w-[1400px] mx-auto">
        <header class="flex flex-col items-center mb-12 text-center">
            <img src="railway logo.png" alt="Logo" class="w-20 mb-4 drop-shadow-[0_0_15px_rgba(56,189,248,0.4)]">
            <h1 class="text-5xl font-black tracking-tighter text-white uppercase italic">E-GARUD <span class="text-sky-400 font-normal lowercase italic">‡§à ‡§ó‡§∞‡•Å‡§°‡§º</span></h1>
            <p class="text-slate-200 text-sm font-bold mt-2 uppercase tracking-wider">(CREW FOOTPLATE ACTIVITY MONITORING SYSTEM)</p>
            <p class="text-slate-400 text-xs font-semibold mt-1">Electrical (OP) Raipur, TELOC CELL S.E.C.Railway</p>
        </header>

        <form id="spmForm" class="space-y-8">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                <div class="glass-card p-8 relative overflow-hidden border-t-4 border-sky-500">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-white uppercase tracking-tight">LP Details</h2>
                        <button type="button" id="manualLpBtn" class="text-[10px] font-bold bg-sky-500/10 text-sky-400 px-3 py-1 rounded-full border border-sky-500/20 hover:bg-sky-500/30 transition-colors">MANUAL MODE</button>
                    </div>
                    <div class="space-y-5">
                        <div>
                            <label for="lpId" class="text-[10px] font-bold text-slate-500 uppercase ml-1">LP ID Number</label>
                            <input type="text" id="lpId" name="lpId" class="input-modern w-full rounded-xl p-4 text-sm" placeholder="Enter ID" required>
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase ml-1">LP Name</label>
                            <input type="text" id="lpName" name="lpName" class="input-modern w-full rounded-xl p-4 text-sm opacity-60" readonly>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-[10px] font-bold text-slate-500 uppercase ml-1">Designation</label>
                                <input type="text" id="lpDesg" name="lpDesg" class="input-modern w-full rounded-xl p-4 text-sm opacity-60" readonly>
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-slate-500 uppercase ml-1">Group CLI</label>
                                <input type="text" id="lpGroupCli" name="lpGroupCli" class="input-modern w-full rounded-xl p-4 text-sm opacity-60" readonly>
                            </div>
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase ml-1">CUG Mobile</label>
                            <input type="text" id="lpCugNumber" name="lpCugNumber" class="input-modern w-full rounded-xl p-4 text-sm opacity-60" readonly>
                        </div>
                    </div>
                </div>

                <div class="glass-card p-8 rounded-3xl relative overflow-hidden border-t-4 border-indigo-500">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-white uppercase tracking-tight">ALP Details</h2>
                        <button type="button" id="manualAlpBtn" class="text-[10px] font-bold bg-indigo-500/10 text-indigo-400 px-3 py-1 rounded-full border border-indigo-500/20 hover:bg-indigo-500/30 transition-colors">MANUAL MODE</button>
                    </div>
                    <div class="space-y-5">
                        <div>
                            <label for="alpId" class="text-[10px] font-bold text-slate-500 uppercase ml-1">ALP ID Number</label>
                            <input type="text" id="alpId" name="alpId" class="input-modern w-full rounded-xl p-4 text-sm" placeholder="Enter ID" required>
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase ml-1">ALP Name</label>
                            <input type="text" id="alpName" name="alpName" class="input-modern w-full rounded-xl p-4 text-sm opacity-60" readonly>
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase ml-1">CUG Number</label>
                            <input type="text" id="alpCugNumber" name="alpCugNumber" class="input-modern w-full rounded-xl p-4 text-sm opacity-60" readonly>
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase ml-1">ALP Group CLI</label>
                            <input type="text" id="alpGroupCli" name="alpGroupCli" class="input-modern w-full rounded-xl p-4 text-sm opacity-60" readonly>
                        </div>
                    </div>
                </div>
                <div class="glass-card p-8 rounded-3xl relative overflow-hidden border-t-4 border-emerald-500">
                    <div class="absolute top-0 left-0 w-1 h-full bg-emerald-500"></div>
                    <h2 class="text-xl font-bold text-white uppercase tracking-tight mb-6">Train & Section</h2>
                    <div class="space-y-5">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-[10px] font-bold text-slate-500 uppercase ml-1">Loco Number</label>
                                <input type="text" id="locoNumber" name="locoNumber" class="input-modern w-full rounded-xl p-4 text-sm" required>
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-slate-500 uppercase ml-1">Train Number</label>
                                <input type="text" id="trainNumber" name="trainNumber" class="input-modern w-full rounded-xl p-4 text-sm" required>
                            </div>
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase ml-1">Block Section</label>
                            <select id="section" name="section" class="input-modern w-full rounded-xl p-4 text-sm appearance-none cursor-pointer" required>
                                <option value="" disabled selected>Select Section</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-[10px] font-bold text-slate-500 uppercase ml-1">From Station</label>
                                <select id="fromSection" name="fromSection" class="input-modern w-full rounded-xl p-4 text-sm"></select>
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-slate-500 uppercase ml-1">To Station</label>
                                <select id="toSection" name="toSection" class="input-modern w-full rounded-xl p-4 text-sm"></select>
                            </div>
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase ml-1">Type of Rake</label>
                            <select id="rakeType" name="rakeType" class="input-modern w-full rounded-xl p-4 text-sm" required>
                                <option value="GOODS">GOODS</option>
                                <option value="COACHING">COACHING</option>
                                <option value="MEMU">MEMU</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div> <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
                <div class="glass-card p-8 rounded-3xl">
                    <h2 class="text-lg font-bold text-slate-300 mb-6 uppercase tracking-wider flex items-center">
                        <span class="mr-3">üë§</span> Reporting CLI Info
                    </h2>
                    <div class="grid grid-cols-2 gap-6">
                        <div class="col-span-2">
                            <label class="text-[10px] font-bold text-slate-500 uppercase ml-1">CLI ID</label>
                            <input type="text" id="cliIdInput" name="cliIdInput" class="input-modern w-full rounded-xl p-4 text-sm" placeholder="Enter CLI ID" required>
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase ml-1">CLI Name</label>
                            <input type="text" id="cliName" class="input-modern w-full rounded-xl p-4 text-sm opacity-60" readonly placeholder="Auto-fill">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase ml-1">CLI HQ</label>
                            <input type="text" id="cliHqDisplay" class="input-modern w-full rounded-xl p-4 text-sm opacity-60" readonly placeholder="Auto-fill">
                        </div>
                    </div>
                </div>
                <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase ml-1">Analysis From</label>
                            <input type="datetime-local" id="fromDateTime" name="fromDateTime" class="input-modern w-full rounded-xl p-4 text-sm" required>
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase ml-1">Analysis To</label>
                            <input type="datetime-local" id="toDateTime" name="toDateTime" class="input-modern w-full rounded-xl p-4 text-sm" required>
                        </div>
                    </div>
                </div>

                <div class="glass-card p-8 rounded-3xl flex flex-col justify-between">
                    <div class="grid grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase ml-1">SPM Vendor</label>
                            <select id="spmType" name="spmType" class="input-modern w-full rounded-xl p-4 text-sm cursor-pointer" required>
                                <option value="">Select SPM</option>
                                <option value="Laxven">Laxven</option>
                                <option value="Medha">Medha</option>
                                <option value="Telpro">Telpro</option>
                                <option value="MR">MR</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase ml-1">SPM Data File</label>
                            <input type="file" id="spmFile" name="spmFile" class="hidden" required>
                            <label for="spmFile" class="input-modern w-full rounded-xl p-4 text-sm flex items-center justify-center cursor-pointer hover:bg-slate-700/50 transition-all">
                                üìÅ Choose File
                            </label>
                        </div>
                    </div>
                    <button type="submit" class="btn-analyze w-full py-6 rounded-2xl text-white font-black text-xl uppercase tracking-[0.2em] shadow-2xl transition-all active:scale-95">
                        Launch Analysis Engine
                    </button>
                    <input type="file" id="cugFile" name="cugFile" class="hidden" accept=".csv">
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-12 pb-10">
                <div class="glass-card p-8 rounded-3xl shadow-inner border-b-4 border-sky-500/30">
                    <h3 class="text-sm font-black text-sky-400 mb-6 uppercase tracking-tighter italic border-b border-sky-500/10 pb-2 flex items-center">
                        <span class="mr-2">üìã</span> Recent Abnormalities (Last 10)
                    </h3>
                    <div id="lp-abnormalities-list" class="text-[11px] text-slate-400 space-y-3 max-h-48 overflow-y-auto pr-4 font-medium custom-scrollbar">
                        Search LP ID to load history from database...
                    </div>
                </div>
                <div class="glass-card p-8 rounded-3xl shadow-inner border-b-4 border-indigo-500/30">
                    <h3 class="text-sm font-black text-indigo-400 mb-6 uppercase tracking-tighter italic border-b border-indigo-500/10 pb-2 flex items-center">
                        <span class="mr-2">üìä</span> Historical Analytics Summary
                    </h3>
                    <div class="grid grid-cols-3 gap-4" id="lp-abnormality-summary-list">
                        <div class="bg-slate-900/80 p-4 rounded-2xl border border-white/5 text-center group hover:border-sky-500/30 transition-all">
                            <span class="text-[9px] text-slate-500 block uppercase mb-1 font-bold">BFT Done</span>
                            <span id="bft-not-done-count" class="text-3xl font-black text-white group-hover:text-sky-400 transition-colors">0</span>
                        </div>
                        <div class="bg-slate-900/80 p-4 rounded-2xl border border-white/5 text-center group hover:border-indigo-500/30 transition-all">
                            <span class="text-[9px] text-slate-500 block uppercase mb-1 font-bold">Late Ctrl</span>
                            <span id="late-controlling-count" class="text-3xl font-black text-white group-hover:text-indigo-400 transition-colors">0</span>
                        </div>
                        <div class="bg-slate-900/80 p-4 rounded-2xl border border-white/5 text-center group hover:border-emerald-500/30 transition-all">
                            <span class="text-[9px] text-slate-500 block uppercase mb-1 font-bold">Over Speed</span>
                            <span id="overspeeding-count" class="text-3xl font-black text-white group-hover:text-emerald-400 transition-colors">0</span>
                        </div>
                    </div>
                    <p id="lp-abnormality-summary-message" class="text-[10px] italic text-slate-600 mt-4 text-center"></p>
                </div>
            </div>
        </form>
    </div>

    <canvas id="speedChart" class="hidden"></canvas>
    <canvas id="stopChart" class="hidden"></canvas>
    
    <div id="loadingOverlay" class="fixed inset-0 bg-slate-950/95 backdrop-blur-2xl hidden flex-col items-center justify-center z-[9999]">
        <div class="relative">
            <div class="w-24 h-24 border-8 border-slate-800 rounded-full"></div>
            <div class="w-24 h-24 border-8 border-sky-500 border-t-transparent rounded-full animate-spin absolute top-0 left-0 shadow-[0_0_50px_rgba(56,189,248,0.3)]"></div>
        </div>
        <h2 class="text-sky-400 font-black mt-8 text-2xl tracking-[0.5em] animate-pulse uppercase italic">E-GARUD Decoding</h2>
        <p class="text-slate-500 text-xs mt-2 uppercase tracking-widest font-bold">Processing Signal & Speed Data...</p>
    </div>

    <script>
        // GLOBALS
        let crewData = [];
        let stationSignalData = [];
        let cliDataMap = {};
      // 1. DATA FETCHING (Drive CSV Integration)
        async function fetchCrewDataFromGoogleSheet() {
            const URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRCXMXkdxzxwCvZtN3uwLGQCmXqmadXbckJrWGtCqaw_ETO1Ci40WysmoqKVVPHpg_7_Exf_AmAxAjy/pub?gid=528051557&single=true&output=csv';
            try {
                const res = await fetch(URL);
                const text = await res.text();
                return new Promise(resolve => {
                    Papa.parse(text, {
                        header: true,
                        skipEmptyLines: true,
                        transformHeader: h => h.trim().toUpperCase(),
                        complete: result => resolve(result.data)
                    });
                });
            } catch(e) { 
                console.error("Crew Fetch Error", e); 
                return []; 
            }
        }

        async function fetchLpAbnormalities(lpId) {
            const listCont = document.getElementById('lp-abnormalities-list');
            listCont.innerHTML = "Processing database...";
            const URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT5A-LI7taO45zhdBz1xdbFZx694C4OK1vpPSV6rVs5VXVpVjqIWuMZdVWKJaFcVIws5qC8ei1Gz9wg/pub?gid=0&single=true&output=csv';
            try {
                const res = await fetch(URL);
                const text = await res.text();
                const data = Papa.parse(text, {header:true, skipEmptyLines:true}).data;
                const lpRecords = data.filter(r => r['LP ID'] === lpId);
                
                if(lpRecords.length === 0) { 
                    listCont.innerHTML = "Safe Trip Profile: No prior abnormalities recorded."; 
                    return; 
                }
                
                listCont.innerHTML = lpRecords.slice(-10).reverse().map(r => `
                    <div class="bg-slate-800/60 p-4 rounded-2xl border border-white/5 shadow-lg mb-2">
                        <span class="text-sky-400 font-bold block mb-1 text-xs underline decoration-sky-500/30">${r.Timestamp}</span>
                        <span class="text-slate-300 leading-relaxed font-semibold">${r.Abnormalities}</span>
                    </div>
                `).join('');

                // Update Trip Counters
                document.getElementById('bft-not-done-count').innerText = lpRecords.filter(r => r.Abnormalities.includes('BFT')).length;
                document.getElementById('late-controlling-count').innerText = lpRecords.filter(r => r.Abnormalities.includes('Controlling')).length;
                document.getElementById('overspeeding-count').innerText = lpRecords.filter(r => r.Abnormalities.includes('Speed')).length;
                
                document.getElementById('lp-abnormality-summary-message').innerText = `Sync Complete: ${lpRecords.length} records processed for LP ${lpId}`;
            } catch(e) { 
                listCont.innerHTML = "System Error: History database unreachable."; 
            }
        }

        // 2. DOMContentLoaded & Core Initialization
        document.addEventListener('DOMContentLoaded', async () => {
            // Load Base Datasets
            crewData = await fetchCrewDataFromGoogleSheet();
            const SIG_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT9Y1hcPadG8CzhtOHddc2XT013TJm9D7J7pZaWORapXpFFMoI4dpFp9PV21XNNk3UuSXFpBqU3KX5m/pub?gid=1398384533&single=true&output=csv';
            
            try {
                const sigRes = await fetch(SIG_URL);
                const sigText = await sigRes.text();
                stationSignalData = Papa.parse(sigText, {
                    header:true, 
                    skipEmptyLines:true, 
                    transformHeader:h=>h.trim().toUpperCase()
                }).data;
            } catch(e) { console.error("Signal Fetch Error", e); }
          // 3. Section & Station Mapping Logic
            const sectionSelect = document.getElementById('section');
            const uniqueSections = [...new Set(stationSignalData.map(r => r['SECTION']))];
            
            uniqueSections.forEach(s => {
                if(s) {
                    const opt = document.createElement('option');
                    opt.value = s;
                    opt.innerText = s;
                    sectionSelect.appendChild(opt);
                }
            });

            sectionSelect.addEventListener('change', (e) => {
                const selectedSection = e.target.value;
                const fromS = document.getElementById('fromSection');
                const toS = document.getElementById('toSection');
                
                fromS.innerHTML = '<option value="">-Select From-</option>';
                toS.innerHTML = '<option value="">-Select To-</option>';
                
                const stations = [...new Set(stationSignalData
                    .filter(r => r['SECTION'] === selectedSection)
                    .map(r => r['STATION']))];
                
                stations.forEach(st => {
                    const opt = document.createElement('option');
                    opt.value = st;
                    opt.innerText = st;
                    fromS.appendChild(opt);
                    toS.appendChild(opt.cloneNode(true));
                });
            });

            // 4. LP ID Input Auto-fill Listener
            document.getElementById('lpId').addEventListener('input', e => {
                const id = e.target.value.toUpperCase();
                e.target.value = id; // Force uppercase in UI
                const rec = crewData.find(r => r['CREWID'] === id);
                if(rec) {
                    document.getElementById('lpName').value = rec['CREW NAME'] || '';
                    document.getElementById('lpDesg').value = rec['DESG'] || '';
                    document.getElementById('lpGroupCli').value = rec['CLI NAME'] || '';
                    document.getElementById('lpCugNumber').value = rec['CUG NUMBER'] || '';
                    fetchLpAbnormalities(id);
                }
            });

            // 5. ALP ID Input Auto-fill Listener
            document.getElementById('alpId').addEventListener('input', e => {
                const id = e.target.value.toUpperCase();
                e.target.value = id;
                const rec = crewData.find(r => r['CREWID'] === id);
                if(rec) {
                    document.getElementById('alpName').value = rec['CREW NAME'] || '';
                    document.getElementById('alpCugNumber').value = rec['CUG NUMBER'] || '';
                    document.getElementById('alpGroupCli').value = rec['CLI NAME'] || '';
                }
            });

            // 6. CLIMICRO.csv Loading for Reporting CLI
            fetch('CLIMICRO.csv')
                .then(response => response.ok ? response.text() : null)
                .then(csvText => {
                    if(csvText) {
                        const lines = csvText.split('\n');
                        for(let i=1; i<lines.length; i++) {
                            const parts = lines[i].split(',');
                            if(parts.length >= 3) {
                                cliDataMap[parts[0].trim().toUpperCase()] = {
                                    name: parts[1].trim(),
                                    hq: parts[2].trim()
                                };
                            }
                        }
                    }
                }).catch(err => console.warn("CLI Micro Database not found"));
        });

        // 7. Manual Entry Mode Toggles
        document.getElementById('manualLpBtn').addEventListener('click', () => {
            ['lpName','lpDesg','lpGroupCli','lpCugNumber'].forEach(id => {
                const el = document.getElementById(id);
                el.readOnly = false;
                el.classList.remove('opacity-60');
            });
            showToast("LP Manual Entry Active");
        });

        document.getElementById('manualAlpBtn').addEventListener('click', () => {
            ['alpName','alpCugNumber','alpGroupCli'].forEach(id => {
                const el = document.getElementById(id);
                el.readOnly = false;
                el.classList.remove('opacity-60');
            });
            showToast("ALP Manual Entry Active");
        });
      // 8. CLI ID Auto-fill & HQ Display
        const cliIdField = document.getElementById('cliIdInput');
        if (cliIdField) {
            cliIdField.addEventListener('input', (e) => {
                const val = e.target.value.toUpperCase();
                e.target.value = val;
                if (cliDataMap[val]) {
                    document.getElementById('cliName').value = cliDataMap[val].name;
                    document.getElementById('cliHqDisplay').value = cliDataMap[val].hq;
                } else {
                    document.getElementById('cliName').value = "";
                    document.getElementById('cliHqDisplay').value = "";
                }
            });
        }

        // 9. Analysis Loading Logic
        window.toggleLoadingOverlay = function(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.style.display = show ? 'flex' : 'none';
        };

        // 10. Form Submission Engine
        document.getElementById('spmForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const spmType = document.getElementById('spmType').value;
            const spmFile = document.getElementById('spmFile').files[0];
            const cugFile = document.getElementById('cugFile').files[0];

            if (!spmType) { alert('Please select an SPM Type.'); return; }
            if (!spmFile) { alert('Please upload an SPM file.'); return; }

            // Enable Loader
            window.toggleLoadingOverlay(true);

            try {
                // Save session HQ to local storage
                const hqVal = document.getElementById('cliHqDisplay').value.trim();
                localStorage.setItem('currentSessionHq', hqVal);

                // Start Cloud Handshake (Notify Google Drive)
                console.log("E-GARUD: Initiating Cloud Upload Handshake...");
                if (window.uploadDataAndFileToGoogle) {
                    const uploadResult = await uploadDataAndFileToGoogle();
                    if (uploadResult.status === 'success') {
                        showToast('Live Cloud Sync Enabled');
                    } else if (uploadResult.status === 'skipped') {
                        console.log("Upload notification skipped - Internal Mode");
                    }
                }

                // Parse CUG Data if uploaded
                let cugData = [];
                if (cugFile) {
                    cugData = await new Promise((resolve) => {
                        Papa.parse(cugFile, {
                            header: true,
                            skipEmptyLines: true,
                            complete: (res) => resolve(res.data)
                        });
                    });
                }

                // Initialize Local Decoding Engine
                console.log(`E-GARUD: Calling local parser for ${spmType}`);
                
                // Logic based on original analyzeSPMData function
                if (typeof analyzeSPMData === 'function') {
                    await analyzeSPMData(spmFile, cugData);
                } else if (window.analyzeData) {
                    await window.analyzeData(spmFile, cugData);
                } else {
                    // Specific vendor parser fallback
                    const parserName = `process${spmType}Data`;
                    if (typeof window[parserName] === 'function') {
                        await window[parserName](spmFile, cugData);
                    } else {
                        // Global analyze script link check
                        if (typeof analyzeData === 'function') {
                            await analyzeData(spmFile, cugData);
                        } else {
                            throw new Error(`Engine for ${spmType} vendor script is not loaded.`);
                        }
                    }
                }

            } catch (error) {
                console.error('Critical Processing Error:', error);
                alert('E-GARUD Engine Exception: ' + error.message);
                window.toggleLoadingOverlay(false);
            }
        });
      // 11. Toast Notification Logic
        function showToast(message) {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const toast = document.createElement('div');
            // Dashboard-consistent modern toast styling
            toast.className = "glass-card bg-slate-800/90 text-sky-400 border border-sky-500/30 px-6 py-4 rounded-2xl shadow-2xl mb-4 transform transition-all duration-500 translate-x-0 opacity-100 flex items-center gap-3";
            toast.style.minWidth = "250px";
            toast.innerHTML = `<span class="text-xl">‚úÖ</span> <span class="font-bold tracking-tight">${message}</span>`;

            container.appendChild(toast);

            // Animate out after 4 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100px)';
                setTimeout(() => toast.remove(), 500);
            }, 4000);
        }

        // 12. Global PDF Report Engine
        async function generatePDF(reportData) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();

            // Setup Dashboard Colors for PDF
            const navyBlue = [15, 23, 42]; // #0f172a
            const skyBlue = [56, 189, 248]; // #38bdf8

            // Professional Report Header
            doc.setFillColor(...navyBlue);
            doc.rect(0, 0, 210, 45, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont("helvetica", "bold");
            doc.text("E-GARUD ANALYTICS REPORT", 105, 18, { align: 'center' });
            
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text("(CREW FOOTPLATE ACTIVITY MONITORING SYSTEM)", 105, 26, { align: 'center' });
            
            doc.setDrawColor(...skyBlue);
            doc.setLineWidth(0.8);
            doc.line(30, 32, 180, 32);
            
            doc.setFontSize(9);
            doc.text(`Raipur Division | Electrical (OP) | Generated: ${new Date().toLocaleString()}`, 105, 38, { align: 'center' });

            // Trip Summary Section
            let yPos = 58;
            doc.setTextColor(...navyBlue);
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.text("Trip Summary", 15, yPos);
            
            yPos += 4;
            doc.setDrawColor(226, 232, 240); // Slate-200
            doc.setLineWidth(0.3);
            doc.line(15, yPos, 195, yPos);
            
            yPos += 10;
            const summaryTable = [
                ["LP Name:", reportData.lpName || 'N/A', "LP ID:", reportData.lpId || 'N/A'],
                ["ALP Name:", reportData.alpName || 'N/A', "ALP ID:", reportData.alpId || 'N/A'],
                ["Loco Number:", reportData.locoNumber || 'N/A', "Train Number:", reportData.trainNumber || 'N/A'],
                ["Section:", reportData.section || 'N/A', "Rake Type:", reportData.rakeType || 'N/A']
            ];

            doc.setFontSize(10);
            summaryTable.forEach(row => {
                doc.setFont("helvetica", "bold");
                doc.text(row[0], 20, yPos);
                doc.setFont("helvetica", "normal");
                doc.text(String(row[1]), 55, yPos);
                
                doc.setFont("helvetica", "bold");
                doc.text(row[2], 110, yPos);
                doc.setFont("helvetica", "normal");
                doc.text(String(row[3]), 145, yPos);
                yPos += 8;
            });
          // 13. Signal Analysis Grid in PDF
            yPos += 5;
            doc.setTextColor(...navyBlue);
            doc.setFontSize(12);
            doc.setFont("helvetica", "bold");
            doc.text("Signal Operational Logs", 15, yPos);
            
            yPos += 6;
            // Table Header Bar
            doc.setFillColor(241, 245, 249);
            doc.rect(15, yPos, 180, 8, 'F');
            doc.setFontSize(8);
            doc.text("Signal Name", 20, yPos + 5);
            doc.text("Aspect", 65, yPos + 5);
            doc.text("Speed (Kmph)", 100, yPos + 5);
            doc.text("Distance (m)", 140, yPos + 5);
            doc.text("Time", 175, yPos + 5);
            
            yPos += 12;
            doc.setFont("helvetica", "normal");
            const logs = reportData.signalLogs || [];
            logs.forEach((log) => {
                if (yPos > 275) { 
                    doc.addPage(); 
                    yPos = 25; 
                    doc.setFillColor(241, 245, 249);
                    doc.rect(15, yPos - 10, 180, 8, 'F');
                    doc.text("Signal Name", 20, yPos - 5);
                    doc.text("Aspect", 65, yPos - 5);
                    doc.text("Speed", 100, yPos - 5);
                    doc.text("Distance", 140, yPos - 5);
                    doc.text("Time", 175, yPos - 5);
                }
                doc.text(String(log.name), 20, yPos);
                doc.text(String(log.aspect), 65, yPos);
                doc.text(String(log.speed), 100, yPos);
                doc.text(String(log.distance), 140, yPos);
                doc.text(String(log.time), 175, yPos);
                yPos += 6.5;
            });

            // 14. Chart Export to PDF
            if (yPos > 190) { doc.addPage(); yPos = 30; } else { yPos += 15; }
            
            doc.setFont("helvetica", "bold");
            doc.setFontSize(12);
            doc.text("Speed Curve Analysis", 15, yPos);
            
            yPos += 5;
            const speedCanvas = document.getElementById('speedChart');
            if (speedCanvas) {
                try {
                    const chartImage = speedCanvas.toDataURL('image/png', 1.0);
                    doc.addImage(chartImage, 'PNG', 15, yPos, 180, 80);
                    yPos += 90;
                } catch (err) {
                    doc.setTextColor(239, 68, 68);
                    doc.text("Note: Speed graph rendering skipped due to data complexity.", 20, yPos + 10);
                    doc.setTextColor(...navyBlue);
                }
            }

            // 15. Final Footer & Auth
            if (yPos > 240) { doc.addPage(); yPos = 30; }
            
            yPos = 255;
            doc.setDrawColor(200, 200, 200);
            doc.line(15, yPos, 195, yPos);
            
            doc.setFontSize(10);
            doc.setFont("helvetica", "bold");
            doc.text("Digitally Generated by E-GARUD Engine", 15, yPos + 8);
            doc.text("Signature of Reporting CLI", 145, yPos + 8);
            
            doc.setFont("helvetica", "normal");
            doc.setFontSize(8);
            doc.text("This report is for monitoring purposes only. Subject to audit verification.", 15, yPos + 13);
            doc.text(`CLI ID: ${document.getElementById('cliIdInput').value}`, 145, yPos + 13);

            // Export Process
            const safeFileName = `E-GARUD_${reportData.lpId || 'Report'}_${Date.now()}.pdf`;
            doc.save(safeFileName);
            
            window.toggleLoadingOverlay(false);
            showToast("Report Successfully Exported");
        }

        // Closing the JS logic
    </script>
    
    <div id="toast-container" class="fixed bottom-8 left-8 flex flex-col items-start z-[99999]"></div>

</body>
</html>
