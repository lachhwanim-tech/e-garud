<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-GARUD Analysis Form</title>
    <link href="styles.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="googleApiHandler.js"></script>
    
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        /* === Modern E-GARUD Theme (Keeping UI Exact) === */
        :root {
            --bg-gradient: linear-gradient(160deg, #020024 0%, #090979 35%, #00d4ff 100%);
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            --text-color: #ffffff;
            --text-muted: #a0a0a0;
            --accent-color: #00d4ff;
            --danger-color: #ff4d4d;
            --font-main: 'Segoe UI', 'Roboto', Helvetica, Arial, sans-serif;
        }

        body {
            font-family: var(--font-main);
            background: var(--bg-gradient);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .container {
            width: 100%;
            max-width: 1250px;
            padding: 30px;
        }

        .logo {
            display: block;
            margin: 0 auto 20px auto;
            width: 280px;
            height: auto;
            filter: drop-shadow(0 0 10px rgba(0, 212, 255, 0.4));
        }

        .header-title h1 {
            font-size: 3.5rem;
            margin: 0;
            text-align: center;
            color: var(--accent-color);
            text-transform: uppercase;
            letter-spacing: 3px;
            text-shadow: 0 0 20px rgba(0, 212, 255, 0.6);
        }

        .header-sub {
            text-align: center;
            margin-top: 10px;
            margin-bottom: 30px;
        }

        .header-sub h3 {
            font-size: 1.2rem;
            margin: 5px 0;
            background: var(--glass-bg);
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            border: var(--glass-border);
        }

        .header-sub h4 {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin: 5px 0;
            font-weight: 400;
        }

        .box {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: var(--glass-border);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--glass-border);
            padding-bottom: 10px;
        }

        .section-header h2 {
            margin: 0;
            font-size: 1.3rem;
            color: var(--accent-color);
            text-transform: uppercase;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .form-section {
            flex: 1;
            min-width: 300px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 0.9rem;
        }

        input, select {
            width: 100%;
            padding: 12px 15px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #fff;
            font-size: 1rem;
            box-sizing: border-box;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
        }

        input[readonly] {
            background: rgba(255, 255, 255, 0.05);
            cursor: not-allowed;
            border-style: dashed;
        }

        button.manual-entry-btn {
            background: var(--danger-color);
            color: white;
            border: none;
            padding: 5px 12px;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
        }

        button[type="submit"] {
            width: 100%;
            padding: 16px;
            background: linear-gradient(90deg, var(--accent-color), #0077cc);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.2rem;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.4);
            margin-top: 10px;
        }

        button[type="submit"]:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 212, 255, 0.6);
        }

        #lp-abnormalities-list, #lp-abnormality-summary-list {
            font-size: 0.9rem;
            line-height: 1.5;
        }
        #lp-abnormality-summary-list li {
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding: 4px 0;
            display: flex;
            justify-content: space-between;
        }

        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast-message {
            background: #fff;
            color: #333;
            padding: 15px 25px;
            border-radius: 8px;
            border-left: 5px solid var(--accent-color);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.4s ease;
            font-weight: 600;
        }
        .toast-message.show { opacity: 1; transform: translateX(0); }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85);
            justify-content: center;
            align-items: center;
            z-index: 3000;
            flex-direction: column;
        }
        .loading-text { color: white; margin-top: 20px; font-size: 1.2rem; }
    </style>
</head>
<body>

    <div class="container">
        <img src="railway logo.png" alt="Railway Logo" class="logo">
        <div class="header-title">
            <h1>E-GARUD (ई-गरुड़)</h1>
        </div>
        <div class="header-sub">
            <h3>ON BOARD CREW DRIVING MONITORING SYSTEM</h3><br>
            <h4>TELOC CELL, Electrical(OP) RAIPUR DIVISION, S.E.C.R.<br>
            (TELOC प्रकोष्ठ, विद्युत (परिचालन) विभाग, रायपुर मंडल, दक्षिण पूर्व मध्य रेलवे)</h4>
        </div>

        <form id="spmForm">
            <div class="form-row">
                <div class="form-section">
                    <div class="section-header">
                        <h2>LP DETAILS</h2>
                        <button type="button" id="manualLpBtn" class="manual-entry-btn">Manual Entry</button>
                    </div>
                    <div class="box">
                        <div class="form-group"><label>LP ID</label><input type="text" id="lpId" required placeholder="Enter ID (e.g., R1234)"></div>
                        <div class="form-group"><label>LP Name</label><input type="text" id="lpName" readonly></div>
                        <div class="form-group"><label>Designation</label><input type="text" id="lpDesg" readonly></div>
                        <div class="form-group"><label>Group CLI</label><input type="text" id="lpGroupCli" readonly></div>
                        <div class="form-group"><label>CUG Number</label><input type="text" id="lpCugNumber" readonly></div>
                    </div>

                    <div class="section-header"><h2>History Profile</h2></div>
                    <div class="box"><div id="lp-abnormalities-list" style="text-align:left;">Enter LP ID to view records.</div></div>
                    <div class="box">
                        <ul id="lp-abnormality-summary-list">
                            <li>BFT not done: <strong id="bft-not-done-count">0</strong></li>
                            <li>BPT not done: <strong id="bpt-not-done-count">0</strong></li>
                            <li>BFT not done as per rule: <strong id="bft-rule-count">0</strong></li>
                            <li>BPT not done as per rule: <strong id="bpt-rule-count">0</strong></li>
                            <li>Late Controlling: <strong id="late-controlling-count">0</strong></li>
                            <li>Overspeeding: <strong id="overspeeding-count">0</strong></li>
                            <li>Others Abnormalities: <strong id="others-abnormalities-count">0</strong></li>
                        </ul>
                        <p id="lp-abnormality-summary-message" style="margin-top: 10px; font-style: italic;"></p>
                    </div>
                </div>

                <div class="form-section">
                    <div class="section-header">
                        <h2>ALP DETAILS</h2>
                        <button type="button" id="manualAlpBtn" class="manual-entry-btn">Manual Entry</button>
                    </div>
                    <div class="box">
                        <div class="form-group"><label>ALP ID</label><input type="text" id="alpId" required></div>
                        <div class="form-group"><label>ALP Name</label><input type="text" id="alpName" readonly></div>
                        <div class="form-group"><label>Designation</label><input type="text" id="alpDesg" readonly></div>
                        <div class="form-group"><label>Group CLI</label><input type="text" id="alpGroupCli" readonly></div>
                        <div class="form-group"><label>CUG Number</label><input type="text" id="alpCugNumber" readonly></div>
                    </div>

                    <div class="section-header" style="margin-top: 30px;"><h2>TRAIN & SECTION</h2></div>
                    <div class="box">
                        <div class="form-group"><label>Loco Number</label><input type="text" id="locoNumber" required></div>
                        <div class="form-group"><label>Train Number</label><input type="text" id="trainNumber" required></div>
                        <div class="form-group">
                            <label>Type of Rake</label>
                            <select id="rakeType" required>
                                <option value="" disabled selected>Select</option>
                                <option value="GOODS">GOODS</option>
                                <option value="COACHING">COACHING</option>
                                <option value="MEMU">MEMU</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Section</label>
                            <select id="section" required><option value="" disabled selected>Select</option></select>
                        </div>
                        <div class="form-row">
                            <div class="form-group" style="flex:1"><label>From</label><select id="fromSection" required></select></div>
                            <div class="form-group" style="flex:1"><label>To</label><select id="toSection" required></select></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section-header"><h2>ANALYSIS PARAMETERS</h2></div>
            <div class="box">
                <div class="form-row">
                    <div class="form-group" style="flex:1">
                        <label>SPM Type</label>
                        <select id="spmType" required>
                            <option value="" disabled selected>Select Type</option>
                            <option value="Laxven">Laxven</option>
                            <option value="Medha">Medha</option>
                            <option value="Telpro">Telpro</option>
                            <option value="TelproNew">TelproNew</option>
                            <option value="MR">MR</option>
                            <option value="VEL">VEL</option>
                            <option value="RTIS">RTIS</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex:1">
                        <label>Max Speed (kmph)</label>
                        <select id="maxPermissibleSpeed" required>
                            <option value="" disabled selected>Select Speed</option>
                            <option value="40">40 kmph</option>
                            <option value="60">60 kmph</option>
                            <option value="75">75 kmph</option>
                            <option value="100">100 kmph</option>
                            <option value="110">110 kmph</option>
                            <option value="120">120 kmph</option>
                            <option value="130">130 kmph</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group" style="flex:1"><label>CLI ID</label><input type="text" id="cliIdInput" required placeholder="Enter CLI ID"></div>
                    <div class="form-group" style="flex:1"><label>CLI Name</label><input type="text" id="cliName" readonly placeholder="Auto-filled"></div>
                    <div class="form-group" style="flex:1"><label>CLI HQ</label><input type="text" id="cliHqDisplay" readonly placeholder="Auto-filled"></div>
                </div>

                <div class="form-row">
                    <div class="form-group" style="flex:1"><label>From Date & Time</label><input type="datetime-local" id="fromDateTime" required></div>
                    <div class="form-group" style="flex:1"><label>To Date & Time</label><input type="datetime-local" id="toDateTime" required></div>
                </div>

                <div class="form-row">
                    <div class="form-group" style="flex:1"><label>Upload SPM File</label><input type="file" id="spmFile" required></div>
                    <div class="form-group" style="flex:1"><label>Upload CUG.csv (Optional)</label><input type="file" id="cugFile" accept=".csv"></div>
                </div>

                <button type="submit">ANALYZE SPM DATA</button>
            </div>
        </form>
    </div>

    <div id="toast-container"></div>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-text">Processing...</div>
    </div>
    <canvas id="speedChart" style="display:none"></canvas>
    <canvas id="stopChart" style="display:none"></canvas>

    <script>
    // --- Global function to toggle loading overlay ---
    window.toggleLoadingOverlay = function(show) {
        document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
    };

    function loadScript(src, callback) {
        const existingScript = document.querySelector('script[data-spm-script]');
        if (existingScript) existingScript.remove();
        const script = document.createElement('script');
        script.src = src;
        script.async = true;
        script.dataset.spmScript = "true";
        script.onload = callback;
        script.onerror = () => {
            alert(`Failed to load script: ${src}. Please ensure the script exists and try again.`);
            window.toggleLoadingOverlay(false);
        };
        document.body.appendChild(script);
    }

    let crewData = [];
    let stationSignalData = [];
    let cliDataMap = {}; 

    const fetchCSV = async (filePath) => {
        try {
            const response = await fetch(filePath);
            if (!response.ok) throw new Error(`Failed to fetch ${filePath}: ${response.statusText}`);
            const text = await response.text();
            return new Promise((resolve) => {
                Papa.parse(text, {
                    header: true,
                    skipEmptyLines: true,
                    transform: (value) => value.trim(),
                    complete: (result) => resolve(result.data),
                });
            });
        } catch (error) {
            console.error(`Error loading ${filePath}:`, error);
            throw error;
        }
    };

    // --- Fetch Crew Data from Google Sheet (SANKET Logic) ---
    async function fetchCrewDataFromGoogleSheet() {
        const SPREADSHEET_ID = '1UtjGKgOXgc9e5NcCgaTg0BVrUVlF6Xx7SbfcHvUxV-A'; 
        const SHEET_NAME = 'Sheet1';
        const API_KEY = 'AIzaSyChXMJaTllbk8kg5w1bjM06PbbJO5MBeLo'; 
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${SHEET_NAME}?key=${API_KEY}`;
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Google Sheets API Error: ${response.status}`);
            const data = await response.json();
            const rows = data.values;
            if (!rows || rows.length === 0) return [];
            const headers = rows[0].map(h => h.trim().toUpperCase()); 
            const crewList = [];
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                if (row.length === 0) continue; 
                const crewObj = {};
                headers.forEach((header, index) => {
                    crewObj[header] = row[index] ? row[index].trim() : ''; 
                });
                crewList.push(crewObj);
            }
            return crewList;
        } catch (error) {
            console.error('Error fetching Crew Data:', error);
            return [];
        }
    }

    // --- Fetch LP Abnormalities (SANKET Logic - Spread Out) ---
    async function fetchLpAbnormalities(lpId) {
        const abnormalitiesListContainer = document.getElementById('lp-abnormalities-list');
        const summaryMessage = document.getElementById('lp-abnormality-summary-message');
        
        abnormalitiesListContainer.innerHTML = 'Loading previous records...';
        summaryMessage.textContent = 'Loading summary...';

        document.getElementById('bft-not-done-count').textContent = '0';
        document.getElementById('bpt-not-done-count').textContent = '0';
        document.getElementById('bft-rule-count').textContent = '0';
        document.getElementById('bpt-rule-count').textContent = '0';
        document.getElementById('late-controlling-count').textContent = '0';
        document.getElementById('overspeeding-count').textContent = '0';
        document.getElementById('others-abnormalities-count').textContent = '0';

        if (!lpId) {
            abnormalitiesListContainer.innerHTML = 'Enter LP ID to view previous records.';
            summaryMessage.textContent = 'Enter LP ID to view summary.';
            return;
        }

        const SPREADSHEET_ID = '1__RDoiJgxgHaHJo5aMByu-q0xJDXPswQopFo9jYAAdM';
        const API_KEY = 'AIzaSyChXMJaTllbk8kg5w1bjM06PbbJO5MBeLo';
        const SHEET_NAME = 'Sheet1';
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${SHEET_NAME}?key=${API_KEY}`;

        try {
            const response = await fetch(url);
            const data = await response.json();
            const rows = data.values || [];

            if (rows.length === 0) {
                abnormalitiesListContainer.innerHTML = 'Could not load data.';
                return;
            }

            const LP_ID_COL = 5; 
            const ABNORMALITY_COL = 39;  
            const COUNT_COL = 40;        
            const ACTION_TAKEN_COL = 41; 
            const BFT_ND_COL = 42; const BPT_ND_COL = 43; const BFT_RULE_COL = 44;
            const BPT_RULE_COL = 45; const LATE_CTRL_COL = 46; const OVERSPEED_COL = 47; const OTHERS_COL = 48;

            let lpFound = false;
            const abnormalities = [];
            let counts = { bft_nd: 0, bpt_nd: 0, bft_rule: 0, bpt_rule: 0, late_ctrl: 0, overspeed: 0, others: 0 };

            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                if (row[LP_ID_COL]?.trim() === lpId) {
                    lpFound = true;
                    const count = parseInt(row[COUNT_COL]);
                    if (row[ABNORMALITY_COL] && !isNaN(count) && count > 0) {
                        abnormalities.push({
                            abnormality: row[ABNORMALITY_COL],
                            action: row[ACTION_TAKEN_COL] || 'N/A',
                            date: row[0] ? row[0].split(' ')[0] : 'N/A'
                        });
                    }
                    counts.bft_nd += parseInt(row[BFT_ND_COL] || 0);
                    counts.bpt_nd += parseInt(row[BPT_ND_COL] || 0);
                    counts.bft_rule += parseInt(row[BFT_RULE_COL] || 0);
                    counts.bpt_rule += parseInt(row[BPT_RULE_COL] || 0);
                    counts.late_ctrl += parseInt(row[LATE_CTRL_COL] || 0);
                    counts.overspeed += parseInt(row[OVERSPEED_COL] || 0);
                    counts.others += parseInt(row[OTHERS_COL] || 0);
                }
            }

            if (!lpFound) {
                abnormalitiesListContainer.innerHTML = 'No prior analysis records found.';
                summaryMessage.textContent = 'No prior analysis records found for summary.';
            } else {
                if (abnormalities.length === 0) {
                    abnormalitiesListContainer.innerHTML = 'NIL abnormality found in previous records.';
                } else {
                    const lastTen = abnormalities.slice(-10).reverse();
                    let listHtml = '<ol>';
                    lastTen.forEach((item) => {
                        listHtml += `<li style="margin-bottom:10px; border-bottom:1px solid rgba(255,255,255,0.1);">
                            <div><strong>Abnormalities (${item.date}):-</strong> ${item.abnormality}</div>
                            <div><strong>Action taken:-</strong> ${item.action}</div>
                        </li>`;
                    });
                    listHtml += '</ol>';
                    abnormalitiesListContainer.innerHTML = listHtml;
                }
                document.getElementById('bft-not-done-count').textContent = counts.bft_nd;
                document.getElementById('bpt-not-done-count').textContent = counts.bpt_nd;
                document.getElementById('bft-rule-count').textContent = counts.bft_rule;
                document.getElementById('bpt-rule-count').textContent = counts.bpt_rule;
                document.getElementById('late-controlling-count').textContent = counts.late_ctrl;
                document.getElementById('overspeeding-count').textContent = counts.overspeed;
                document.getElementById('others-abnormalities-count').textContent = counts.others;
                summaryMessage.textContent = '';
            }
        } catch (error) {
            abnormalitiesListContainer.innerHTML = 'Error fetching records.';
        }
    }

    document.addEventListener('DOMContentLoaded', async () => {
        try {
            // Load CLI Data (Spread Out Logic)
            fetch('CLIMICRO.csv').then(response => response.text()).then(csvText => {
                const lines = csvText.split('\n');
                for(let i=1; i<lines.length; i++) {
                    const line = lines[i].trim();
                    if(line) {
                        const parts = line.split(','); 
                        if(parts.length >= 3) {
                            const id = parts[0].trim().toUpperCase();
                            cliDataMap[id] = { name: parts[1].trim(), hq: parts[2].trim() };
                        }
                    }
                }
            });

            crewData = await fetchCrewDataFromGoogleSheet();
            stationSignalData = await fetchCSV('Station_Signal_Interdistant.csv');
            window.stationSignalData = stationSignalData;

            const sectionSelect = document.getElementById('section');
            const uniqueSections = [...new Set(stationSignalData.map(row => row['SECTION']))];
            uniqueSections.forEach(section => {
                const option = document.createElement('option');
                option.value = section; option.textContent = section;
                sectionSelect.appendChild(option);
            });

            const fromSectionSelect = document.getElementById('fromSection');
            const toSectionSelect = document.getElementById('toSection');

            sectionSelect.addEventListener('change', (e) => {
                const selectedSection = e.target.value;
                fromSectionSelect.innerHTML = toSectionSelect.innerHTML = '<option value="" disabled selected>Select</option>';
                if (selectedSection) {
                    const stations = [...new Set(stationSignalData.filter(row => row['SECTION'] === selectedSection).map(row => row['STATION']))];
                    stations.forEach(station => {
                        fromSectionSelect.appendChild(new Option(station, station));
                        toSectionSelect.appendChild(new Option(station, station));
                    });
                }
            });

            // LP ID Listener (Spread Out - No Consolidated Helper)
            document.getElementById('lpId').addEventListener('input', (e) => {
                const val = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
                e.target.value = val;
                const rec = crewData.find(record => record['CREWID'] === val);
                if (rec) {
                    document.getElementById('lpName').value = rec['CREW NAME'] || '';
                    document.getElementById('lpDesg').value = rec['DESG'] || '';
                    document.getElementById('lpGroupCli').value = rec['CLI NAME'] || '';
                    document.getElementById('lpCugNumber').value = rec['CUG NUMBER'] || '';
                    fetchLpAbnormalities(val);
                } else {
                    document.getElementById('lpName').value = document.getElementById('lpDesg').value = document.getElementById('lpGroupCli').value = document.getElementById('lpCugNumber').value = '';
                    fetchLpAbnormalities(null);
                }
            });

            // ALP ID Listener
            document.getElementById('alpId').addEventListener('input', (e) => {
                const val = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
                e.target.value = val;
                const rec = crewData.find(record => record['CREWID'] === val);
                if (rec) {
                    document.getElementById('alpName').value = rec['CREW NAME'] || '';
                    document.getElementById('alpDesg').value = rec['DESG'] || '';
                    document.getElementById('alpGroupCli').value = rec['CLI NAME'] || '';
                    document.getElementById('alpCugNumber').value = rec['CUG NUMBER'] || '';
                } else {
                    document.getElementById('alpName').value = document.getElementById('alpDesg').value = document.getElementById('alpGroupCli').value = document.getElementById('alpCugNumber').value = '';
                }
            });

            document.getElementById('cliIdInput').addEventListener('input', (e) => {
                const val = e.target.value.toUpperCase(); e.target.value = val;
                if(cliDataMap[val]) {
                    document.getElementById('cliName').value = cliDataMap[val].name;
                    document.getElementById('cliHqDisplay').value = cliDataMap[val].hq;
                } else {
                    document.getElementById('cliName').value = document.getElementById('cliHqDisplay').value = "";
                }
            });

            document.getElementById('spmType').addEventListener('change', (e) => {
                const type = e.target.value;
                const fileInput = document.getElementById('spmFile');
                if (type === 'Medha') fileInput.accept = '.txt';
                else if (type === 'MR' || type === 'VEL') fileInput.accept = '.pdf';
                else fileInput.accept = '.xlsx,.xls,.csv';
                if (type) loadScript(`${type}.js`, () => console.log(`${type}.js loaded`));
            });

            document.getElementById('manualLpBtn').addEventListener('click', () => {
                ['lpName', 'lpDesg', 'lpGroupCli', 'lpCugNumber'].forEach(id => document.getElementById(id).readOnly = false);
            });
            document.getElementById('manualAlpBtn').addEventListener('click', () => {
                ['alpName', 'alpDesg', 'alpGroupCli', 'alpCugNumber'].forEach(id => document.getElementById(id).readOnly = false);
            });

            // Submission Handler (Exactly as SANKET logic flow)
            document.getElementById('spmForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                if(document.getElementById('fromSection').value === document.getElementById('toSection').value) 
                    return alert("From and To stations cannot be same");

                localStorage.setItem('currentSessionHq', document.getElementById('cliHqDisplay').value.trim());
                window.toggleLoadingOverlay(true);
                showToast("Starting Analysis...");

                try {
                    const uploadResult = await uploadDataAndFileToGoogle();
                    if (uploadResult.status === 'success') showToast('File uploaded successfully.');
                    else showToast('Drive Upload skipped/failed. Processing locally...');

                    const cugFile = document.getElementById('cugFile').files[0];
                    let processedCug = [];
                    if (cugFile) {
                        const text = await cugFile.text();
                        const results = Papa.parse(text, {header:true, skipEmptyLines:true});
                        const regex = /^(?:(\d{2})[-\/](\d{2})[-\/](\d{4})|(\d{4})[-\/](\d{2})[-\/](\d{2}))\s(\d{2}):(\d{2})(?::(\d{2}))?$/;
                        processedCug = results.data.map(call => {
                            const startStr = (call['Start Date & Time'] || '').trim();
                            const endStr = (call['End Date & Time'] || '').trim();
                            const sM = startStr.match(regex); const eM = endStr.match(regex);
                            if(sM && eM) {
                                let sD, eD; const sSec = sM[9] || '00', eSec = eM[9] || '00';
                                if(sM[1]) {
                                    sD = new Date(`${sM[3]}-${sM[2]}-${sM[1]}T${sM[7]}:${sM[8]}:${sSec}`);
                                    eD = new Date(`${eM[3]}-${eM[2]}-${eM[1]}T${eM[7]}:${eM[8]}:${eSec}`);
                                } else {
                                    sD = new Date(`${sM[4]}-${sM[5]}-${sM[6]}T${sM[7]}:${sM[8]}:${sSec}`);
                                    eD = new Date(`${eM[4]}-${eM[5]}-${eM[6]}T${eM[7]}:${eM[8]}:${eSec}`);
                                }
                                return {...call, startDateTime: sD, endDateTime: eD, duration: parseInt(call['Duration in Sec']) || 0, 'CUG MOBILE NO': call['CUG MOBILE NO']?.trim()};
                            }
                            return null;
                        }).filter(Boolean);
                    }

                    const spmFile = document.getElementById('spmFile').files[0];
                    if (typeof analyzeSPMData === 'function') await analyzeSPMData(spmFile, processedCug);
                    else if (window.analyzeData) await window.analyzeData(spmFile, processedCug);
                    else throw new Error("Analysis function not found.");

                } catch (error) {
                    alert('Error: ' + error.message);
                    window.toggleLoadingOverlay(false);
                }
            });

        } catch (error) {
            alert('Failed to load initial data.');
            window.toggleLoadingOverlay(false);
        }
    });

    function showToast(message) {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = 'toast-message';
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
            toast.classList.remove('show');
            toast.addEventListener('transitionend', () => toast.remove());
        }, 4000);
    }
    </script>
</body>
</html>
